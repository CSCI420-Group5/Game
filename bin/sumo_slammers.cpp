/*
   Main game loop
 */

#include <iostream>
#include <SFML/Graphics.hpp>
#include "Wrestler.h"
#include "LocationalMap.h"
#include "Logic.h"
#include "PlayerView.h"
#include "MainMenu.h"
#include "Terrain.h"
#include "Profile.h"
#include "Projectile.h"

int main(int argc, char** argv)
{
    const int a[] = 
        {
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        };

    LocationalMap loc_map;
    loc_map.init(800, 600, 30, a);

    // create main window
    sf::RenderWindow App(sf::VideoMode(800,600,32), "Sumo Slammers - SFML");

    // vectors of collidable objects and set of collisions
    std::vector<Collidable*> actors;
    std::vector<std::set<long int> > collision_sets;

    // Create menu
    MainMenu menu(800, 600);

    // Create profile
    Profile profile;
    profile.setLives(3);
    profile.setCharacter("Fumio");
    profile.setLevel("Generic Level");

    // create wrestlers
    Wrestler human_sumo;
    human_sumo.init(30, 30, 200, 290);
    human_sumo.setIsHuman(true);
    human_sumo.setIsWrestler(true);
    human_sumo.setHasProjectile(false);

    Wrestler ai_sumo;
    ai_sumo.init(30, 30, 400, 300);
    ai_sumo.setIsHuman(false);
    ai_sumo.setIsWrestler(true);
    ai_sumo.setHasProjectile(false);

    Wrestler ai_sumo2;
    ai_sumo2.init(30, 30, 400, 330);
    ai_sumo2.setIsHuman(false);
    ai_sumo2.setIsWrestler(true);
    ai_sumo2.setHasProjectile(false);

    Wrestler ai_sumo3;
    ai_sumo3.init(30, 30, 400, 360);
    ai_sumo3.setIsHuman(false);
    ai_sumo3.setIsWrestler(true);
    ai_sumo3.setHasProjectile(false);

    // create a projectile
    Projectile proj;
    proj.init(30, 30, 370, 300);
    proj.setIsWrestler(false);
    proj.setHasProjectile(true);

    actors.push_back(&human_sumo);
    actors.push_back(&ai_sumo);
    actors.push_back(&ai_sumo2);
    actors.push_back(&ai_sumo3);
    actors.push_back(&proj);
    
    // create view object of collidables
    PlayerView view;
    view.init();

    // create game timer used to keep things synched
    sf::Clock timer;
    const int level[] =
        {
            66, 67, 67, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 67, 67, 68,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            78, 79, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 78, 79, 80,
            90, 91, 92, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 90, 91, 92,
            102, 103, 104, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 102, 103, 104,
            114, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 116,
        };
        const int genlevel[] =
        {
            695, 67, 67, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 67, 67, 68,
            78, 79, 80, 695, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 697, 78, 79, 80,
            78, 79, 80, 725, 80, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 727, 78, 79, 80,
            78, 79, 80, 725, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 727, 78, 79, 80,
            78, 79, 80, 725, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 727, 78, 79, 80,
            78, 79, 80, 725, 103, 103, 103, 695, 696, 696, 696, 696, 696, 696, 696, 696, 697, 103, 103, 103, 103, 727, 78, 79, 80,
            78, 79, 80, 725, 103, 103, 103, 725, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 727, 78, 79, 80,
            78, 79, 80, 725, 103, 103, 103, 725, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 727, 78, 79, 80,
            78, 79, 80, 725, 103, 103, 103, 725, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 727, 78, 79, 80,
            78, 79, 80, 725, 103, 103, 103, 725, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 727, 78, 79, 80,
            78, 79, 80, 725, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 727, 78, 79, 80,
            78, 79, 80, 725, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 727, 78, 79, 80,
            78, 79, 80, 725, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 727, 78, 79, 80,
            78, 79, 80, 725, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 727, 78, 79, 80,
            78, 79, 80, 725, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 727, 78, 79, 80,
            78, 79, 80, 725, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 727, 78, 79, 80,
            90, 91, 92, 755, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 757, 90, 91, 92,
            102, 103, 104, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 103, 102, 103, 104,
            114, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 115, 116,
        };
        const int background[] =
        {
            116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116, 116,
            207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207,
            77, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 79,
            77, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 79,
            77, 78, 78, 78, 78, 695, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 697, 78, 78, 78, 78, 79,
            77, 78, 78, 78, 78, 21, 21, 22, 23, 21, 20, 20, 21, 20, 21, 21, 20, 21, 20, 21, 78, 78, 78, 78, 79,
            77, 78, 78, 78, 78, 21, 51, 52, 53, 20, 110, 111, 111, 112, 20, 21, 20, 21, 20, 21, 78, 78, 78, 78, 79,
            77, 78, 78, 78, 78, 21, 81, 82, 83, 20, 140, 141, 141, 142, 20, 21, 25, 26, 21, 21, 78, 78, 78, 78, 79,
            77, 78, 78, 78, 78, 21, 21, 20, 20, 21, 170, 171, 171, 172, 20, 21, 20, 21, 20, 21, 78, 78, 78, 78, 79,
            77, 78, 78, 78, 78, 21, 24, 25, 26, 20, 21, 24, 25, 20, 21, 20, 21, 20, 21, 21, 78, 78, 78, 78, 79,
            77, 78, 78, 78, 78, 21, 21, 20, 113, 114, 115, 21, 20, 20, 24, 25, 26, 21, 20, 21, 78, 78, 78, 78, 79,
            77, 78, 78, 78, 78, 21, 20, 20, 143, 144, 145, 21, 20, 20, 54, 55, 56, 21, 20, 21, 78, 78, 78, 78, 79,
            77, 78, 78, 78, 78, 21, 21, 21, 173, 174, 175, 25, 26, 20, 84, 85, 86, 20, 21, 21, 78, 78, 78, 78, 79,
            77, 78, 78, 78, 78, 21, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 21, 78, 78, 78, 78, 79,
            77, 78, 78, 78, 78, 755, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 757, 78, 78, 78, 78, 79,
            77, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 79,
            107, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 108, 109,
            105, 106, 163, 14, 15, 14, 16, 14, 16, 15, 17, 14, 15, 16, 14, 16, 15, 14, 16, 14, 14, 16, 15, 14, 15,
            192, 193, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207, 207,
        };
         const int accents[] =
        {
            298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298,
            47, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 49,
            298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298,
            298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298,
            298, 298, 298, 298, 298, 695, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 696, 697, 298, 298, 298, 298, 298,
            298, 298, 298, 298, 298, 725, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 727, 298, 298, 298, 298, 298,
            298, 298, 298, 298, 298, 725, 298, 134, 298, 298, 298, 298, 298, 298, 298, 134, 298, 298, 298, 727, 298, 298, 298, 298, 298,
            298, 298, 298, 298, 298, 725, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 727, 298, 298, 298, 298, 298,
            298, 298, 298, 298, 298, 725, 298, 298, 298, 298, 298, 356, 298, 298, 298, 298, 298, 298, 298, 727, 298, 298, 298, 298, 298,
            298, 298, 298, 298, 298, 725, 298, 298, 298, 298, 298, 298, 298, 133, 298, 298, 298, 298, 298, 727, 298, 298, 298, 298, 298,
            298, 298, 298, 298, 298, 725, 132, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 727, 298, 298, 298, 298, 298,
            298, 298, 298, 298, 298, 725, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 727, 298, 298, 298, 298, 298,
            298, 298, 298, 298, 298, 725, 298, 298, 298, 298, 298, 298, 357, 298, 298, 298, 298, 298, 298, 727, 298, 298, 298, 298, 298,
            298, 298, 298, 298, 298, 725, 298, 298, 134, 298, 298, 298, 298, 298, 298, 298, 132, 298, 298, 727, 298, 298, 298, 298, 298,
            298, 298, 298, 298, 298, 755, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 756, 757, 298, 298, 298, 298, 298,
            298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298,
            298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298,
            167, 168, 169, 14, 167, 168, 169, 14, 167, 168, 169, 14, 167, 168, 169, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298, 298,
            197, 198, 199, 44, 198, 199, 44, 198, 199, 44, 198, 199, 198, 44, 199, 198, 199, 44, 198, 44, 199, 198, 199, 198, 199,
        };
    

    // create the tilemap from the level definition
    Terrain map;
    if (!map.load("resources/hyptosis.png", sf::Vector2u(32, 32), background, 25, 20))
        return -1;
    Terrain layer;
    if (!layer.load("resources/hyptosis.png", sf::Vector2u(32, 32), accents, 25, 20))
        return -1;

    // start main loop
    while(App.isOpen())
    {
        // process events
        sf::Event Event;
        while(App.pollEvent(Event))
        {
            // Exit
            if(Event.type == sf::Event::Closed)
                App.close();
            
        }

        // Menu status indicating game should be playing
        if (menu.getStatus() == 1)
        {
            //Don't update the game logic unless a certain amount of time has passed
            if(timer.getElapsedTime().asSeconds() > 1.0/60)
            {
                timer.restart();

                // set speeds of wrestlers
                for (int i=0; i<actors.size(); i++) {
                    if (actors[i]->isWrestler()) {
                        if (dynamic_cast<Wrestler*>(actors[i])->isHuman())
                            getInputSetSpd(actors[i], loc_map, actors, "");
                        else
                            setAISpd(actors[i], loc_map, actors);
                    }
                }

                // add wrestlers to locational map
                loc_map.addFuture(actors);

                // check for collisions, need to check if results of collisions cause new collisions and compute again
                collision_sets = calcCollision(loc_map, actors);
                while (collision_sets.size() > 0){
                    loc_map.clearCells();
                    loc_map.addFuture(actors);

                    collision_sets = calcCollision(loc_map, actors);
                }

                moveActors(actors);

                // clear location map
                loc_map.clearCells();
                collision_sets.clear();
            }

            // clear screen and fill with blue
            App.clear(sf::Color::Green);
            App.draw(map);
            App.draw(layer);
            // TODO have basic shape (rectangle?) for WrestlerView objects
            // associated with created actors and draw them
            view.drawActors(App, actors);
            view.drawHUD(App, profile);
            view.drawStaminaBar(App, actors[0]);
        }

        // menu status indicating that menu should be up
        else
        {
            menu.navigate(App);
            menu.draw(App);
        }

        // display
        App.display();
    }

    // Done.
    return 0;
}
